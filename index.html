<!DOCTYPE html>
<html>
<head>
  <title>Visual Perception Experiment</title>
  <!-- Include jsPsych core and the needed plugin -->
  <script src="jspsych/dist/jspsych.js"></script>
  <script src="jspsych/dist/plugin-html-button-response.js"></script>
  <!-- Include the default jsPsych CSS for basic styling -->
  <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    p { text-align: justify; }
    /* University logo */
    .university-logo {
      position: absolute;
      top: 10px;
      left: 10px;
      height: 60px;
    }
    /* Welcome text container */
    .welcome-container {
      margin-top: 20px;
      margin-left: 100px;
      margin-right: 20px;
      text-align: left;
    }
    /* Demo/Experiment image styling */
    .demo-image {
      max-width: 45vw;
      max-height: calc(100vh - 150px);
      width: auto;
      height: auto;
    }
    /* jsPsych button styling */
    .jspsych-btn {
      font-weight: bold;
      font-size: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .jspsych-btn:hover {
      background-color: #45a049;
    }
    /* Fixed container for YES button */
    #yes-button-container {
      position: fixed;
      bottom: 0;
      right: 40px;
      z-index: 1000;
    }
    /* Fullscreen overlay */
    #fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(128,128,128,0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fullscreen-overlay .prompt-box {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      text-align: center;
      max-width: 90%;
    }
    #fullscreen-overlay button {
      font-size: 16px;
      margin: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #fullscreen-overlay button:hover { opacity: 0.9; }
    /* Loading screen styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      margin-top: 50px;
    }
    .loading-container p { font-size: 24px; margin-bottom: 10px; }
    .progress-bar-container {
      width: 300px;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #007bff;
      border-radius: 10px;
      transition: width 0.2s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Container for YES button -->
  <div id="yes-button-container"></div>

  <script>
    /*********************************************************
     * GLOBAL VARIABLES & HELPER FUNCTIONS
     *********************************************************/
    // Global array to store YES click events.
    var yesClickEvents = [];
    // Clear yesClickEvents when actual experiment starts.
    function clearYesClickEvents() { yesClickEvents = []; }
    // Global flag for pausing.
    var demoPaused = false;
    function pauseAwareTimeout(callback, delay) {
      setTimeout(function waitForResume() {
        if (demoPaused) {
          setTimeout(waitForResume, 100);
        } else {
          callback();
        }
      }, delay);
    }
    // (Optional) parse pixel shift info from a filename.
    function parseShiftFromFilename(url) {
      var match = url.match(/_(L|R|U|D)(\d+)px/);
      if (!match) return { direction: null, shift: 0 };
      return { direction: match[1], shift: parseInt(match[2], 10) };
    }
    /*********************************************************
     * Initialize jsPsych
     *********************************************************/
    var jsPsych = initJsPsych({
      override_safe_mode: true,
      experiment_width: 1000
    });
    /*********************************************************
     * Fullscreen Listener & Overlay
     *********************************************************/
    document.addEventListener("fullscreenchange", function () {
      if (!document.fullscreenElement) {
        demoPaused = true;
        var overlay = document.createElement("div");
        overlay.id = "fullscreen-overlay";
        var promptBox = document.createElement("div");
        promptBox.className = "prompt-box";
        var message = document.createElement("p");
        message.innerHTML = `
          You have exited full screen mode.<br><br>
          Press <strong>Resume</strong> to re-enter full screen, or 
          <strong>Quit</strong> to return to the main screen (all progress lost!).
        `;
        promptBox.appendChild(message);
        var btnQuit = document.createElement("button");
        btnQuit.textContent = "Quit";
        btnQuit.style.backgroundColor = "#d9534f";
        btnQuit.style.color = "white";
        btnQuit.onclick = function () {
          if (document.getElementById("fullscreen-overlay")) {
            document.body.removeChild(overlay);
          }
          window.location.reload();
        };
        var btnResume = document.createElement("button");
        btnResume.textContent = "Resume";
        btnResume.style.backgroundColor = "#5cb85c";
        btnResume.style.color = "white";
        btnResume.onclick = function () {
          if (document.getElementById("fullscreen-overlay")) {
            document.body.removeChild(overlay);
          }
          document.documentElement.requestFullscreen().then(function () {
            demoPaused = false;
            if (typeof jsPsych.resumeExperiment === "function") {
              jsPsych.resumeExperiment();
            }
          }).catch(function (err) {
            console.error("Error re-entering full screen:", err);
          });
        };
        promptBox.appendChild(btnQuit);
        promptBox.appendChild(btnResume);
        overlay.appendChild(promptBox);
        document.body.appendChild(overlay);
        if (typeof jsPsych.pauseExperiment === "function") {
          jsPsych.pauseExperiment();
        }
      }
    });
  </script>

  <!-- Object and Group Definitions -->
  <script>
    var objectNames = [
      "Book Shelves", "Chess", "Wheel", "Food Platter", "Fruits",
      "Humming Bird", "Plant", "Swing", "Vase", "Wood"
    ];
    var groups = {
      "Group1": ["Center_100%_Plain", "Center_100%_LowContrast"],
      "Group2": ["Left_100%_Plain", "Right_100%_Plain"],
      "Group3": ["Up_100%_Plain", "Down_100%_Plain"],
      "Group4": ["Center_125%_Plain", "Center_75%_Plain"],
      "Group5": ["Center_100%_PatternHoriz", "Center_100%_PatternVert", "Center_100%_Messy"]
    };
    function getRandomElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
  </script>

  <!-- Function to fetch image filenames -->
  <script>
    function fetchImageFilenames(searchKey) {
      return fetch("https://lasvientuexperimentdata.s3.ap-southeast-1.amazonaws.com/Rendered+Images/filenames.json")
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          var matchingFiles = data.filter(file => file.name.indexOf(searchKey) !== -1);
          matchingFiles.sort((a, b) => a.name.localeCompare(b.name));
          return matchingFiles.map(file => file.name);
        });
    }
  </script>

  <!-- jsPsych Timeline Components -->
  <script>
    /*************** 1) Welcome Page ***************/
    var welcomePage = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <img src="logo/NTU Logo.png" alt="NTU Logo" class="university-logo" style="height: 230px; width: auto;">
        <div class="welcome-container">
          <h1>Visual Perception Experiment</h1>
          <p>
            This study aims to evaluate the sensitivity of the human visual system
            to subtle shifts in the position of a salient object. You will see images
            where a key object may be displaced in various directions. Your task is
            to detect these shifts.
          </p>
          <p>
            <strong>Important:</strong> This experiment must be done on a desktop or laptop in full screen mode.
          </p>
          <p>
            <input type="checkbox" id="device-confirm" name="device-confirm">
            <label for="device-confirm">I confirm that I am using a desktop PC or laptop.</label>
          </p>
        </div>
      `,
      choices: ['Continue'],
      on_load: function () {
        var btn = document.querySelector(".jspsych-btn");
        btn.disabled = true;
        document.getElementById("device-confirm").addEventListener("change", function () {
          btn.disabled = !this.checked;
        });
      },
      on_finish: function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(function (err) {
            console.error("Error attempting to enable full-screen mode:", err);
          });
        }
      }
    };

    /*************** 2) Demo Instructions Page ***************/
    var demoPage = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <img src="logo/NTU Logo.png" alt="NTU Logo" class="university-logo" style="height: 230px; width: auto;">
        <div style="text-align: center;">
          <h3 style="margin-bottom: 5px;">DEMO: The shifted image will move <b>to the left</b></h3>
          <div style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
            <div style="margin: 5px; text-align: center;">
              <img src="image/00001_Cube_Center_100_Plain_N0px.png" alt="Reference Image" style="width: 300px; height: auto;"><br>
              <span>Reference Image</span>
            </div>
            <div style="margin: 5px; text-align: center;">
              <img src="image/00031_Cube_Center_100_Plain_L30px.png" alt="Shifted Image" style="width: 300px; height: auto;"><br>
              <span>Shifted Image</span>
            </div>
          </div>
          <div style="margin-top: 10px; text-align: left; max-width: 1200px; margin-left: auto; margin-right: auto; font-size: 14px; line-height: 1.2;">
            <p>
              In this demo, the left image is a fixed reference, while the right image will update periodically.
              The shifted image refreshes every 3 seconds. Between updates, it and the YES button will be temporarily disabled,
              but the layout remains in place.
            </p>
            <p>
              Once you notice a change (shift) in the right image relative to the left image, click "YES" to indicate detection.
              If you do not notice a change, it will keep updating until the final image.
            </p>
            <p>
              <strong>Note:</strong> Quitting the experiment at any point will erase all progress!
            </p>
            <p>
              Please confirm you have read these instructions.
            </p>
          </div>
          <div style="margin-top: 10px; font-size: 14px;">
            <input type="checkbox" id="demo-confirm" name="demo-confirm">
            <label for="demo-confirm">I have read and understood the instructions.</label>
          </div>
        </div>
      `,
      choices: ['Start DEMO'],
      on_load: function () {
        var btn = document.querySelector(".jspsych-btn");
        btn.disabled = true;
        document.getElementById("demo-confirm").addEventListener("change", function () {
          btn.disabled = !this.checked;
        });
      }
    };

    /*************** 3) Dynamic Demo Trial ***************/
    var dynamicDemoTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div id="dynamic-demo-container"></div>',
      choices: ['YES'],
      response_ends_trial: false,
      on_load: function () {
        var btn = document.querySelector(".jspsych-btn");
        var yesBtnContainer = document.getElementById('yes-button-container');
        yesBtnContainer.appendChild(btn);
        yesBtnContainer.style.display = "none";
        btn.disabled = true;
        btn.style.opacity = "0.5";

        var container = document.getElementById("dynamic-demo-container");
        var numImages = 31;
        var demoImages = [];
        var imageFilenames = [];
        var loadingStartTime = Date.now();
        var trialFinished = false;  // Guard against actions after trial ends

        imageFilenames.push("00001_Cube_Center_100_Plain_N0px.png");
        for (var j = 2; j <= numImages; j++) {
          var shift = j - 1;
          var padded = (j < 10) ? "0000" + j : "000" + j;
          var filename = padded + "_Cube_Center_100_Plain_L" + shift + "px.png";
          imageFilenames.push(filename);
        }

        var loadingScreenTimeout = setTimeout(function () {
          container.innerHTML = `
            <div class="loading-container">
              <p>Loading experiment, please wait...</p>
              <div class="progress-bar-container">
                <div id="loading-bar" class="progress-bar"></div>
              </div>
            </div>
          `;
          var loadingBar = document.getElementById("loading-bar");
          var progress = 0;
          var interval = setInterval(function () {
            progress += 5;
            if (progress >= 100) {
              clearInterval(interval);
            } else {
              loadingBar.style.width = progress + "%";
            }
          }, 100);
        }, 100);

        function loadImage(src) {
          return new Promise(function (resolve, reject) {
            var img = new Image();
            img.onload = function () { resolve(img); };
            img.onerror = function () { reject(src); };
            img.src = "image/" + encodeURIComponent(src);
          });
        }

        Promise.all(imageFilenames.map(loadImage)).then(function (images) {
          demoImages = images;
          var loadingDuration = Date.now() - loadingStartTime;
          var minDisplayTime = 1000;
          var remainingTime = minDisplayTime - loadingDuration;
          setTimeout(function () {
            clearTimeout(loadingScreenTimeout);
            startCountdown();
          }, Math.max(0, remainingTime));
        }).catch(function (err) {
          container.innerHTML = "<p>Error loading image: " + err + "</p>";
        });

        // Helper function to update the shifted image with onload callback
        function updateShiftImage(newSrc, callback) {
          var shiftImg = document.getElementById("shift-image");
          if (!shiftImg) return;
          shiftImg.style.visibility = "hidden";
          shiftImg.onload = function() {
            shiftImg.style.visibility = "visible";
            shiftImg.onload = null;
            callback();
          };
          shiftImg.src = newSrc;
          if (shiftImg.complete) {  // If cached, trigger callback immediately.
            shiftImg.onload();
          }
        }

        function startCountdown() {
          btn.style.display = "none";
          container.innerHTML = `
            <div id="demo-header" style="text-align: center; margin-top: 10px;">
              <h3 style="margin: 0 0 10px 0;">
                Saliency object is moving <span style="font-size:1.5em; text-decoration: underline;">LEFT</span>
              </h3>
              <h3 id="countdown" style="font-size:72px; font-weight:bold; margin:100px;">3</h3>
            </div>
          `;
          var count = 3;
          function countdownTick() {
            if (demoPaused) {
              setTimeout(countdownTick, 100);
              return;
            }
            count--;
            var cd = document.getElementById("countdown");
            if (!cd) return;
            cd.innerHTML = count;
            if (count <= 0) {
              startDemo();
            } else {
              setTimeout(countdownTick, 1000);
            }
          }
          setTimeout(countdownTick, 1000);
        }

        var currentIndex = 0;
        function startDemo() {
          container.innerHTML = `
            <div id="demo-header" style="text-align: center; margin-top: 10px;">
              <h3 style="margin: 0 0 10px 0;">
                Saliency object is moving <span style="font-size:1.5em; text-decoration: underline;">LEFT</span>
              </h3>
            </div>
            <div id="demo-content" style="display: flex; justify-content: center; align-items: center;">
              <div style="margin: 5px; text-align: center;">
                <img id="ref-image" src="${demoImages[0].src}" class="demo-image">
                <br><span>Reference Image</span>
              </div>
              <div style="margin: 5px; text-align: center;">
                <img id="shift-image" src="${demoImages[0].src}" class="demo-image" style="visibility: visible;">
                <br><span>Shifted Image</span>
              </div>
            </div>
          `;
          document.getElementById("yes-button-container").style.display = "block";
          btn.style.display = "inline-block";
          btn.disabled = false;
          btn.style.opacity = "1";
          pauseAwareTimeout(nextImage, 3000);
        }

        function nextImage() {
          if (trialFinished) return;
          if (currentIndex >= demoImages.length - 1) {
            finishTrial();
            return;
          }
          btn.disabled = true;
          btn.style.opacity = "0.5";
          // Use the helper function to update the shifted image
          updateShiftImage(demoImages[currentIndex+1].src, function () {
            currentIndex++;
            btn.disabled = false;
            btn.style.opacity = "1";
            pauseAwareTimeout(nextImage, 3000);
          });
        }

        btn.addEventListener("click", function () {
          if (trialFinished) return;
          trialFinished = true;
          var shiftImg = document.getElementById("shift-image");
          if (shiftImg) {
            var parsed = parseShiftFromFilename(shiftImg.src);
            yesClickEvents.push({
              phase: "demo",
              direction: parsed.direction,
              shift: parsed.shift,
              filename: shiftImg.src
            });
          }
          finishTrial();
        });

        function finishTrial() {
          var btnParent = document.querySelector(".jspsych-btn")?.parentNode;
          if (btnParent) {
            btnParent.removeChild(document.querySelector(".jspsych-btn"));
          }
          jsPsych.finishTrial({ chosen_shift: currentIndex });
        }
      }
    };

    /*************** 4) Demo Completion Page ***************/
    var demoCompleteTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2 style="text-align:center;">You have completed the demo</h2>
        <p style="max-width: 800px; margin: 0 auto; font-size: 16px; text-align: left;">
          <strong>Rules Recap:</strong><br>
          1) The reference image is constant.<br>
          2) The shifted image updates every 3 seconds.<br>
          3) When you notice a change, click the YES button.<br>
          4) Quitting midway disqualifies your progress.<br>
        </p>
        <p style="text-align:center; margin-top:20px;">
          Choose an option below:
        </p>
      `,
      choices: ['Redo DEMO', 'START ACTUAL EXPERIMENT'],
      on_finish: function () {
        // Loop back for a redo if response === 0.
      }
    };

    /*************** 5) Experiment Instructions Page ***************/
    var experimentInstructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        // Randomly select a group from all available groups.
        window.selectedGroupKey = getRandomElement(Object.keys(groups));
        window.selectedObject = getRandomElement(objectNames);
        var props = groups[window.selectedGroupKey];
        var setsCount = props.length;
        return `
          <div style="text-align: center;">
            <h2>Actual Experiment:</h2>
            <p>The experiment will now run for a series of keys based on one randomly selected object and group.</p>
            <p>
              You have been assigned to <strong>${window.selectedGroupKey}</strong>.<br>
              You will perform <strong>${setsCount} set${setsCount > 1 ? 's' : ''}</strong> of experiments.
            </p>
            <p>
              In each set, the same salient object will be used. The object will shift in 4 directions –
              Left, Right, Up, and Down. After each directional shift, please press <strong>YES</strong>
              once you observe a difference.
            </p>
            <p>Once ready, please press START.</p>
          </div>
        `;
      },
      choices: ['START']
    };

    /*************** 6) Multi-Key Actual Experiment Trial ***************/
    var multiKeyExperimentTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div id="actual-exp-container"></div>',
      choices: ['YES'],
      response_ends_trial: false,
      on_load: function () {
        // Clear demo yes click events so only actual clicks are recorded.
        clearYesClickEvents();

        var btn = document.querySelector(".jspsych-btn");
        if (!btn) {
          btn = document.createElement("button");
          btn.className = "jspsych-btn";
          btn.textContent = "YES";
        }
        var yesBtnContainer = document.getElementById('yes-button-container');
        yesBtnContainer.appendChild(btn);
        yesBtnContainer.style.display = "none";
        btn.style.display = "none";

        var container = document.getElementById("actual-exp-container");
        var properties = groups[window.selectedGroupKey]; // For Group5, this is 3 properties, now treated equally.
        var experimentResults = [];
        function runExperimentForProperty(index) {
          if (index >= properties.length) {
            if (btn.parentNode) {
              btn.parentNode.removeChild(btn);
            }
            var trialData = {
              object: window.selectedObject,
              group: window.selectedGroupKey,
              experimentResults: experimentResults
            };
            jsPsych.finishTrial(trialData);
            return;
          }
          var selectedProperty = properties[index];
          var searchKey = window.selectedObject + "_" + selectedProperty;
          runDirectionalExperiment(searchKey, selectedProperty, function(phaseResults, filenames) {
            experimentResults.push({
              property: selectedProperty,
              phaseResults: phaseResults,
              filenames: filenames
            });
            runExperimentForProperty(index + 1);
          });
        }
        runExperimentForProperty(0);

        function runDirectionalExperiment(searchKey, propertyName, callback) {
          container.innerHTML = `
            <div class="loading-container">
              <p>Loading experiment, please wait...</p>
              <div class="progress-bar-container">
                <div id="exp-loading-bar" class="progress-bar"></div>
              </div>
            </div>
          `;
          yesBtnContainer.style.display = "none";
          var loadingBar = document.getElementById("exp-loading-bar");
          var progress = 0;
          var loadingInterval = setInterval(function () {
            progress += 5;
            if (progress >= 100) {
              clearInterval(loadingInterval);
            } else {
              loadingBar.style.width = progress + "%";
            }
          }, 100);
          fetchImageFilenames(searchKey).then(function(fileNames) {
            if (fileNames.length === 0) {
              container.innerHTML = "<p>No matching images found for key: " + searchKey + ".</p>";
              callback({}, []);
              return;
            }
            if (fileNames.length < 401) {
              container.innerHTML = "<p>Expected ≥ 401 images for key: " + searchKey + ", but got " + fileNames.length + ".</p>";
              callback({}, fileNames);
              return;
            }
            fileNames = fileNames.slice(0, 401);
            var originalFilename = fileNames[0];
            var leftFilenamesAll = fileNames.slice(1, 101);
            var rightFilenamesAll = fileNames.slice(101, 201);
            var upFilenamesAll = fileNames.slice(201, 301);
            var downFilenamesAll = fileNames.slice(301, 401);
            var leftFilenames = leftFilenamesAll.filter((_, i) => i % 2 === 1);
            var rightFilenames = rightFilenamesAll.filter((_, i) => i % 2 === 1);
            var upFilenames = upFilenamesAll.filter((_, i) => i % 2 === 1);
            var downFilenames = downFilenamesAll.filter((_, i) => i % 2 === 1);
            var allFilenames = [originalFilename]
              .concat(leftFilenames)
              .concat(rightFilenames)
              .concat(upFilenames)
              .concat(downFilenames);
            var baseImageURL = "https://lasvientuexperimentdata.s3.ap-southeast-1.amazonaws.com/Rendered+Images/";
            function loadImage(src) {
              return new Promise(function(resolve, reject) {
                var img = new Image();
                img.onload = function() { resolve(img); };
                img.onerror = function() { reject(src); };
                img.src = baseImageURL + encodeURIComponent(src);
              });
            }
            Promise.all(allFilenames.map(loadImage)).then(function(loadedImages) {
              var imageMap = {};
              for (var i = 0; i < allFilenames.length; i++) {
                imageMap[allFilenames[i]] = loadedImages[i];
              }
              var originalImage = imageMap[originalFilename];
              var leftImages = leftFilenames.map(fn => imageMap[fn]);
              var rightImages = rightFilenames.map(fn => imageMap[fn]);
              var upImages = upFilenames.map(fn => imageMap[fn]);
              var downImages = downFilenames.map(fn => imageMap[fn]);
              var phases = [
                { direction: "L", label: "LEFT", images: leftImages },
                { direction: "R", label: "RIGHT", images: rightImages },
                { direction: "U", label: "UP", images: upImages },
                { direction: "D", label: "DOWN", images: downImages }
              ];
              var currentPhaseIndex = 0;
              var currentImageIndex = 0;
              var phaseResults = {};
              var phaseActive = false;
              var yesHandler = function () {
                if (!phaseActive) return;
                var phase = phases[currentPhaseIndex];
                var currentImg = phase.images[currentImageIndex];
                if (currentImg) {
                  var currentFilename = currentImg.src;
                  var parsed = parseShiftFromFilename(currentFilename);
                  yesClickEvents.push({
                    phase: "actual",
                    group: window.selectedGroupKey,
                    property: propertyName,
                    direction: parsed.direction,
                    shift: parsed.shift,
                    filename: currentFilename
                  });
                  phaseResults[phase.label] = {
                    imageIndex: currentImageIndex,
                    filename: currentFilename,
                    pixelShift: parsed.shift,
                    direction: parsed.direction
                  };
                }
                moveToNextPhase();
              };
              btn.addEventListener("click", yesHandler);
              
              // Helper function for phase image update using onload.
              function updatePhaseImage(newSrc, callback) {
                var shiftImg = document.getElementById("exp-shift-image");
                if (!shiftImg) return;
                shiftImg.style.visibility = "hidden";
                shiftImg.onload = function() {
                  shiftImg.style.visibility = "visible";
                  shiftImg.onload = null;
                  callback();
                };
                shiftImg.src = newSrc;
                if (shiftImg.complete) {
                  shiftImg.onload();
                }
              }

              function startPhaseCountdown() {
                phaseActive = false;
                yesBtnContainer.style.display = "none";
                container.innerHTML = `
                  <div id="exp-header" style="text-align: center; margin-top: 10px;">
                    <h3 style="margin: 0 0 10px 0;">Saliency object will be moving <span style="font-size:1.5em; text-decoration: underline;">${phases[currentPhaseIndex].label}</span></h3>
                    <h3 id="exp-countdown" style="font-size:72px; font-weight:bold; margin:100px;">3</h3>
                  </div>
                `;
                var count = 3;
                function expCountdownTick() {
                  if (demoPaused) {
                    setTimeout(expCountdownTick, 100);
                    return;
                  }
                  count--;
                  var cd = document.getElementById("exp-countdown");
                  if (!cd) return;
                  cd.innerHTML = count;
                  if (count <= 0) {
                    startPhase();
                  } else {
                    setTimeout(expCountdownTick, 1000);
                  }
                }
                setTimeout(expCountdownTick, 1000);
              }
              function startPhase() {
                phaseActive = true;
                currentImageIndex = 0;
                yesBtnContainer.style.display = "block";
                btn.style.display = "inline-block";
                btn.disabled = false;
                btn.style.opacity = "1";
                showPhaseImages();
              }
              function showPhaseImages() {
                if (!phaseActive) return;
                var phase = phases[currentPhaseIndex];
                container.innerHTML = `
                  <div id="exp-header" style="text-align: center; margin-top: 10px;">
                    <h3 style="margin: 0 0 10px 0;">Saliency object will be moving <span style="font-size:1.5em; text-decoration: underline;">${phase.label}</span></h3>
                  </div>
                  <div id="exp-content" style="display: flex; justify-content: center; align-items: center;">
                    <div style="margin: 5px; text-align: center;">
                      <img id="exp-ref-image" src="${originalImage.src}" class="demo-image">
                      <br><span>Reference Image</span>
                    </div>
                    <div style="margin: 5px; text-align: center;">
                      <img id="exp-shift-image" src="${phase.images[currentImageIndex].src}" class="demo-image" style="visibility: visible;">
                      <br><span>Shifted Image</span>
                    </div>
                  </div>
                `;
                pauseAwareTimeout(advancePhaseImage, 3000);
              }
              function advancePhaseImage() {
                if (!phaseActive) return;
                var phase = phases[currentPhaseIndex];
                if (currentImageIndex >= phase.images.length - 1) {
                  moveToNextPhase();
                  return;
                }
                btn.disabled = true;
                btn.style.opacity = "0.5";
                updatePhaseImage(phase.images[currentImageIndex+1].src, function() {
                  currentImageIndex++;
                  btn.disabled = false;
                  btn.style.opacity = "1";
                  pauseAwareTimeout(advancePhaseImage, 3000);
                });
              }
              function moveToNextPhase() {
                phaseActive = false;
                currentPhaseIndex++;
                if (currentPhaseIndex < phases.length) {
                  startPhaseCountdown();
                } else {
                  btn.removeEventListener("click", yesHandler);
                  callback(phaseResults, {
                    original: originalFilename,
                    left: leftFilenames,
                    right: rightFilenames,
                    up: upFilenames,
                    down: downFilenames
                  });
                }
              }
              startPhaseCountdown();
            }).catch(function (err) {
              container.innerHTML = "<p>Error loading images: " + err + "</p>";
            });
          }).catch(function (error) {
            container.innerHTML = "<p>Error fetching image filenames: " + error + "</p>";
          });
        }
      }
    };

    /*************** 7) Final Submission + Data Serialization ***************/
    var finalSubmissionTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div style="text-align:center;">
          <h2>Thank you!</h2>
          <p>You have completed the entire experiment.</p>
          <p>Please click the button below to submit your data.</p>
        </div>
      `,
      choices: ['Submit Data'],
      on_finish: function() {
        // A) Collect trial data summary.
        var jsPsychDataArray = jsPsych.data.get().values();
        var trialSummary = jsPsychDataArray.map(function(trial) {
          return {
            trialIndex: trial.trial_index,
            trialType: trial.trial_type,
            response: trial.response,
            rt: trial.rt,
            chosenShift: trial.chosen_shift !== undefined ? trial.chosen_shift : null
          };
        });
        // B) Build the final payload as a plain object.
        var finalPayload = {
          participantID: "user123",
          selectedObject: window.selectedObject || null,
          group: window.selectedGroupKey || null,
          yesClicks: yesClickEvents, // Array of plain objects gathered during the experiment.
          trialSummary: trialSummary
        };
        // C) Post the payload to your AWS endpoint.
        var AWS_ENDPOINT = "https://i7nc0ict3h.execute-api.ap-southeast-1.amazonaws.com/storedata";
        fetch(AWS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(finalPayload)
        })
        .then(response => response.json())
        .then(result => {
          console.log("Data posted successfully:", result);
          // Optionally display a success message or redirect.
        })
        .catch(error => {
          console.error("Error posting data:", error);
          // Optionally display an error message.
        });
      }
    };

    /*************** Build the Master Timeline ***************/
    var timeline = [];
    timeline.push(welcomePage);
    var demoTimeline = {
      timeline: [demoPage, dynamicDemoTrial, demoCompleteTrial],
      loop_function: function (data) {
        var last_trial = data.values()[data.values().length - 1];
        return last_trial.response === 0;
      }
    };
    timeline.push(demoTimeline);
    timeline.push(experimentInstructions);
    timeline.push(multiKeyExperimentTrial);
    timeline.push(finalSubmissionTrial);
    jsPsych.run(timeline);
  </script>
</body>
</html>
